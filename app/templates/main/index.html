{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è{% endblock %}

{% block styles %}
<style>
    .game-map {
        display: flex;
        flex-direction: column;
    }
    
    .map-row {
        display: flex;
    }
    
    .map-cell {
        width: 60px;
        height: 60px;
        border: 2px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        cursor: pointer;
    }
    
    .building-icon {
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
    }
    
    .faction-label {
        position: absolute;
        top: 2px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 7px;
        font-weight: bold;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 1px 2px;
        border-radius: 2px;
        z-index: 10;
    }
    
    .voting-overlay {
        position: absolute;
        bottom: 2px;
        right: 2px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 10px;
    }
    
    .voting-building {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(128, 128, 128, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        opacity: 0.7;
    }
    
    .action-buttons {
        position: absolute;
        top: 2px;
        right: 2px;
        display: none;
    }
    
    .map-cell:hover .action-buttons {
        display: block;
    }
    
    .action-btn {
        width: 20px;
        height: 20px;
        font-size: 10px;
        padding: 0;
        margin: 1px;
    }
    
    /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –º–∞–∫–µ—Ç–∞ */
    .game-container {
        display: flex;
        gap: 20px;
    }
    
    .map-section {
        flex: 1;
        min-width: 0;
    }
    
    .status-section {
        width: 300px;
        flex-shrink: 0;
    }
    
    .map-container {
        display: grid;
        grid-template-columns: repeat(7, 60px);
        gap: 2px;
        justify-content: center;
        padding: 5px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="game-container">
        <div class="map-section">
            <div class="card">
                <div class="card-header">
                    <h5>–ö–∞—Ä—Ç–∞ –º–∏—Ä–∞</h5>
                </div>
                <div class="card-body position-relative">
                    <div id="map-container" class="map-container">
                        <!-- –ö–∞—Ä—Ç–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                    <div id="cell-actions-container" class="cell-actions-container" style="display: none; position: absolute; z-index: 1000; background: white; border: 1px solid #ddd; padding: 10px; border-radius: 5px; box-shadow: 0 0 10px rgba(0,0,0,0.1);"></div>
                </div>
            </div>
            
            <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–µ–∫—Ü–∏—é –ª–æ–≥–æ–≤ -->
            {% if current_user.is_authenticated and current_user.faction %}
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">–ñ—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π —Ñ—Ä–∞–∫—Ü–∏–∏</h5>
                    <span class="badge bg-primary">–•–æ–¥ <span id="log-turn-number">1</span></span>
                </div>
                <div class="card-body">
                    <div id="faction-logs" class="faction-logs" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-center text-muted">
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏–π...</p>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <div class="status-section">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">–°—Ç–∞—Ç—É—Å –∏–≥—Ä—ã</h5>
                </div>
                <div class="card-body">
                    <div id="game-timer" class="mb-3">
                        <h6>–•–æ–¥ <span id="turn-number">1</span></h6>
                        <h6>–î–æ –∫–æ–Ω—Ü–∞ —Ö–æ–¥–∞:</h6>
                        <div class="display-4 text-center" id="turn-timer">30</div>
                    </div>
                    
                    {% if current_user.is_authenticated and current_user.faction %}
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">–†–µ—Å—É—Ä—Å—ã —Ñ—Ä–∞–∫—Ü–∏–∏</h5>
                        </div>
                        <div class="card-body">
                            <div class="faction-resources">
                                <h6>–†–µ—Å—É—Ä—Å—ã —Ñ—Ä–∞–∫—Ü–∏–∏:</h6>
                                <ul class="list-unstyled">
                                    <li><span id="gold-amount">{{ current_user.faction.gold }}</span></li>
                                    <li><span id="wood-amount">{{ current_user.faction.wood }}</span></li>
                                    <li><span id="stone-amount">{{ current_user.faction.stone }}</span></li>
                                    <li><span id="ore-amount">{{ current_user.faction.ore }}</span></li>
                                    <li><span id="warriors-amount">{{ current_user.faction.warriors }}</span></li>
                                </ul>
                                <div class="mt-2">
                                    <small class="text-muted">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–∏–Ω–æ–≤: 1 –∑–æ–ª–æ—Ç–æ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –≤–æ–∏–Ω–∞ –≤ —Ö–æ–¥</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            {% if current_user.is_authenticated and current_user.faction %}
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">–î–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-danger" id="capture-cell-btn">–ó–∞—Ö–≤–∞—Ç–∏—Ç—å –∫–ª–µ—Ç–∫—É</button>
                        <button class="btn btn-primary" id="defend-cell-btn">–ó–∞—â–∏—Ç–∏—Ç—å –∫–ª–µ—Ç–∫—É</button>
                        <button class="btn btn-warning" id="recruit-warriors-btn">–ù–∞–Ω—è—Ç—å –≤–æ–∏–Ω–æ–≤</button>
                        <button class="btn btn-success" id="build-btn">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∑–¥–∞–Ω–∏–µ</button>
                        <button class="btn btn-info" id="transfer-resources-btn">–ü–µ—Ä–µ–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã</button>
                        
                        
                    </div>
                </div>
            </div>
            {% else %}
            <div class="card">
                <div class="card-body">
                    <p class="text-center">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –≤ –∏–≥—Ä–µ</p>
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('auth.login') }}" class="btn btn-primary">–í–æ–π—Ç–∏</a>
                        <a href="{{ url_for('auth.register') }}" class="btn btn-secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–ª–µ—Ç–∫–∏ -->
<div class="modal fade" id="captureCellModal" tabindex="-1" aria-labelledby="captureCellModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="captureCellModalLabel">–ó–∞—Ö–≤–∞—Ç –∫–ª–µ—Ç–∫–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="capture-form">
                    <div class="mb-3">
                        <label for="capture-x" class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X</label>
                        <input type="number" class="form-control" id="capture-x" required>
                    </div>
                    <div class="mb-3">
                        <label for="capture-y" class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y</label>
                        <input type="number" class="form-control" id="capture-y" required>
                    </div>
                    <div class="mb-3">
                        <label for="capture-warriors" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∏–Ω–æ–≤</label>
                        <input type="number" class="form-control" id="capture-warriors" min="1" required>
                        <small class="text-muted">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="available-warriors">0</span> –≤–æ–∏–Ω–æ–≤</small>
                        <small class="text-muted d-block">–°—Ç–æ–∏–º–æ—Å—Ç—å —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è: 1 –∑–æ–ª–æ—Ç–æ –∑–∞ –∫–∞–∂–¥–æ–≥–æ –≤–æ–∏–Ω–∞ –≤ —Ö–æ–¥</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="confirm-capture">–ó–∞—Ö–≤–∞—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ -->
<div class="modal fade" id="buildModal" tabindex="-1" aria-labelledby="buildModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buildModalLabel">–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="build-form">
                    <div class="mb-3">
                        <label for="build-x" class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X</label>
                        <input type="number" class="form-control" id="build-x" required>
                    </div>
                    <div class="mb-3">
                        <label for="build-y" class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y</label>
                        <input type="number" class="form-control" id="build-y" required>
                    </div>
                    <div class="mb-3">
                        <label for="building-type" class="form-label">–¢–∏–ø –∑–¥–∞–Ω–∏—è</label>
                        <select class="form-select" id="building-type" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–¥–∞–Ω–∏—è</option>
                            <option value="SAWMILL">–õ–µ—Å–æ–ø–∏–ª–∫–∞ (+3 –¥–µ—Ä–µ–≤–∞ –∑–∞ —Ö–æ–¥)</option>
                            <option value="MINE">–®–∞—Ö—Ç–∞ (+3 —Ä—É–¥—ã –∑–∞ —Ö–æ–¥)</option>
                            <option value="QUARRY">–ö–∞—Ä—å–µ—Ä (+3 –∫–∞–º–Ω—è –∑–∞ —Ö–æ–¥)</option>
                            <option value="WAREHOUSE">–°–∫–ª–∞–¥ (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)</option>
                            <option value="BARRACKS">–ö–∞–∑–∞—Ä–º—ã (—É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –ª–∏–º–∏—Ç –≤–æ–∏–Ω–æ–≤)</option>
                        </select>
                        <small class="text-muted d-block mt-2">–í—Å–µ –∑–¥–∞–Ω–∏—è —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –ª–∏–º–∏—Ç –≤–æ–∏–Ω–æ–≤. –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–¥–∞–Ω–∏—è –¥–∞—é—Ç +3 –∫ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–º—É —Ä–µ—Å—É—Ä—Å—É –∑–∞ —Ö–æ–¥.</small>
                        <small class="text-muted d-block">–ó–∞–º–æ–∫ —è–≤–ª—è–µ—Ç—Å—è –≥–ª–∞–≤–Ω—ã–º –∑–¥–∞–Ω–∏–µ–º —Ñ—Ä–∞–∫—Ü–∏–∏ –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω.</small>
                    </div>
                    
                    <div class="mb-3">
                        <h6>–°—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞:</h6>
                        <div id="building-cost" class="mt-2">
                            <p class="mb-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å</p>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="confirm-build">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ -->
<div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transferModalLabel">–ü–µ—Ä–µ–¥–∞—á–∞ —Ä–µ—Å—É—Ä—Å–æ–≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="transfer-form">
                    <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç -->
                    <input type="hidden" id="transfer-x" value="0">
                    <input type="hidden" id="transfer-y" value="0">
                    
                    <div class="mb-3">
                        <label for="transfer-faction" class="form-label">–§—Ä–∞–∫—Ü–∏—è</label>
                        <select class="form-select" id="transfer-faction" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ—Ä–∞–∫—Ü–∏—é</option>
                            {% for faction in factions %}
                                {% if faction.id != current_user.faction_id %}
                                <option value="{{ faction.id }}">{{ faction.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="transfer-gold" class="form-label">–ó–æ–ª–æ—Ç–æ</label>
                        <input type="number" class="form-control" id="transfer-gold" min="0" value="0">
                        <small class="text-muted">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="available-gold" class="fw-bold text-success">0</span></small>
                    </div>
                    <div class="mb-3">
                        <label for="transfer-wood" class="form-label">–î–µ—Ä–µ–≤–æ</label>
                        <input type="number" class="form-control" id="transfer-wood" min="0" value="0">
                        <small class="text-muted">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="available-wood" class="fw-bold text-success">0</span></small>
                    </div>
                    <div class="mb-3">
                        <label for="transfer-stone" class="form-label">–ö–∞–º–µ–Ω—å</label>
                        <input type="number" class="form-control" id="transfer-stone" min="0" value="0">
                        <small class="text-muted">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="available-stone" class="fw-bold text-success">0</span></small>
                    </div>
                    <div class="mb-3">
                        <label for="transfer-ore" class="form-label">–†—É–¥–∞</label>
                        <input type="number" class="form-control" id="transfer-ore" min="0" value="0">
                        <small class="text-muted">–î–æ—Å—Ç—É–ø–Ω–æ: <span id="available-ore" class="fw-bold text-success">0</span></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="confirm-transfer">–ü–µ—Ä–µ–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞–π–º–∞ –≤–æ–∏–Ω–æ–≤ -->
<div class="modal fade" id="recruitWarriorsModal" tabindex="-1" aria-labelledby="recruitWarriorsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="recruitWarriorsModalLabel">–ù–∞–Ω—è—Ç—å –≤–æ–∏–Ω–æ–≤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="recruit-form">
                    <div class="mb-3">
                        <label for="recruit-warriors" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∏–Ω–æ–≤</label>
                        <input type="number" class="form-control" id="recruit-warriors" min="1" value="1" required>
                        <small class="text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å: 5 –∑–æ–ª–æ—Ç–∞ –∑–∞ –≤–æ–∏–Ω–∞</small>
                    </div>
                    <div class="mb-3">
                        <p>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: <span id="total-recruit-cost">5</span> –∑–æ–ª–æ—Ç–∞</p>
                        <p>–î–æ—Å—Ç—É–ø–Ω–æ –∑–æ–ª–æ—Ç–∞: <span id="available-gold-recruit">0</span></p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="confirm-recruit">–ù–∞–Ω—è—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–ª–µ—Ç–∫–∏ -->
<div class="modal fade" id="defendCellModal" tabindex="-1" aria-labelledby="defendCellModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="defendCellModalLabel">–ó–∞—â–∏—Ç–∏—Ç—å –∫–ª–µ—Ç–∫—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∏–Ω–æ–≤ –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–ª–µ—Ç–∫–∏:</p>
                <div class="mb-3">
                    <label for="defend-warriors" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∏–Ω–æ–≤:</label>
                    <input type="number" class="form-control" id="defend-warriors" min="1" value="1">
                    <div class="form-text">–£ –≤–∞—Å –¥–æ—Å—Ç—É–ø–Ω–æ: <span id="available-warriors-defend">0</span> –≤–æ–∏–Ω–æ–≤</div>
                </div>
                <div class="mb-3">
                    <label for="defend-x" class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X:</label>
                    <input type="number" class="form-control" id="defend-x" min="0" max="6" value="0">
                </div>
                <div class="mb-3">
                    <label for="defend-y" class="form-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y:</label>
                    <input type="number" class="form-control" id="defend-y" min="0" max="6" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-danger" id="confirm-defend">–ó–∞—â–∏—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let userFactionId = {{ current_user.faction_id if current_user.is_authenticated and current_user.faction else 'null' }};
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ —Ö–æ–¥–∞
    function updateTurnTimer() {
        fetch('/api/turn')
            .then(response => response.json())
            .then(data => {
                document.getElementById('turn-number').textContent = data.current_turn;
                document.getElementById('turn-timer').textContent = data.seconds_left;
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
    function updateGameState() {
        updateTurnTimer();
        updateMap();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –ª–æ–≥–æ–≤
        if (userFactionId) {
            updateResources();
            updateFactionLogs();
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Ñ—Ä–∞–∫—Ü–∏–∏
    function updateFactionLogs() {
        fetch('/api/faction_logs')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ª–æ–≥–æ–≤:', data.message);
                    return;
                }
                
                const logsContainer = document.getElementById('faction-logs');
                if (!logsContainer) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Ö–æ–¥–∞ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –ª–æ–≥–æ–≤
                const logTurnNumber = document.getElementById('log-turn-number');
                if (logTurnNumber) {
                    logTurnNumber.textContent = data.current_turn;
                }
                
                // –ï—Å–ª–∏ –Ω–µ—Ç –ª–æ–≥–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (data.logs.length === 0) {
                    logsContainer.innerHTML = `
                        <div class="text-center text-muted">
                            <p>–í —ç—Ç–æ–º —Ö–æ–¥—É –≤–∞—à–∞ —Ñ—Ä–∞–∫—Ü–∏—è –µ—â–µ –Ω–µ —Å–æ–≤–µ—Ä—à–∞–ª–∞ –¥–µ–π—Å—Ç–≤–∏–π</p>
                        </div>
                    `;
                    return;
                }
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –ª–æ–≥–æ–≤
                let logsHTML = '<ul class="list-group list-group-flush">';
                
                data.logs.forEach(log => {
                    logsHTML += `
                        <li class="list-group-item p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">${log.timestamp}</small>
                                <small class="text-primary">${log.username}</small>
                            </div>
                            <div>${log.message}</div>
                        </li>
                    `;
                });
                
                logsHTML += '</ul>';
                logsContainer.innerHTML = logsHTML;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ª–æ–≥–æ–≤ —Ñ—Ä–∞–∫—Ü–∏–∏:', error);
            });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    function updateMap() {
        fetch('/api/map')
            .then(response => response.json())
            .then(mapData => {
                console.log('Map data:', mapData);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö
                if (!Array.isArray(mapData)) {
                    console.error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç—ã:', mapData);
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –∫–ª–µ—Ç–∫—É
                mapData.forEach(cell => {
                    // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –∫–ª–µ—Ç–∫–∏
                    const cellElement = document.querySelector(`.map-cell[data-x="${cell.x}"][data-y="${cell.y}"]`);
                    if (!cellElement) {
                        console.warn(`–≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –∫–ª–µ—Ç–∫–∏ (${cell.x}, ${cell.y}) –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                        return;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ—Ä–∞–∫—Ü–∏—é
                    if (cell.faction_id) {
                        cellElement.dataset.factionId = cell.faction_id;
                        cellElement.style.backgroundColor = getFactionColor(cell.faction_id);
                    } else {
                        cellElement.dataset.factionId = '';
                        cellElement.style.backgroundColor = '';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–¥–∞–Ω–∏–µ
                    const buildingIcon = cellElement.querySelector('.building-icon');
                    if (buildingIcon) {
                        if (cell.building_type) {
                            buildingIcon.innerHTML = getBuildingIcon(cell.building_type);
                            buildingIcon.style.display = 'flex';
                        } else if (cell.faction_id && isCornerCell(parseInt(cell.x), parseInt(cell.y))) {
                            // –ï—Å–ª–∏ —ç—Ç–æ —É–≥–ª–æ–≤–∞—è –∫–ª–µ—Ç–∫–∞ —Å —Ñ—Ä–∞–∫—Ü–∏–µ–π, –Ω–æ –±–µ–∑ –∑–¥–∞–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–º–æ–∫
                            buildingIcon.innerHTML = getBuildingIcon('castle');
                            buildingIcon.style.display = 'flex';
                        } else {
                            buildingIcon.style.display = 'none';
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞—Ö –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫ —Å –ø–æ—Å—Ç—Ä–æ–π–∫–∞–º–∏
                    let defendersElement = cellElement.querySelector('.neutral-defenders');
                    if (!defendersElement) {
                        defendersElement = document.createElement('div');
                        defendersElement.className = 'neutral-defenders';
                        defendersElement.style.position = 'absolute';
                        defendersElement.style.bottom = '2px';
                        defendersElement.style.right = '2px';
                        defendersElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞
                        defendersElement.style.color = 'white';
                        defendersElement.style.padding = '0px 2px 1px 2px'; // –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã: –≤–µ—Ä—Ö 0px, –ø—Ä–∞–≤–æ 2px, –Ω–∏–∑ 1px, –ª–µ–≤–æ 2px
                        defendersElement.style.borderRadius = '3px';
                        defendersElement.style.fontSize = '10px'; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
                        defendersElement.style.zIndex = '5'; // –î–æ–±–∞–≤–ª—è–µ–º z-index
                        cellElement.appendChild(defendersElement);
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞—Ö
                    if (cell.faction_id === null && cell.building_type && cell.neutral_defenders) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SVG, –µ—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–∫–æ–Ω–∫—É
                        const shieldImg = new Image();
                        shieldImg.src = '/static/assets/resources/–©–∏—Ç.svg';
                        
                        shieldImg.onload = function() {
                            defendersElement.innerHTML = `<img src="/static/assets/resources/–©–∏—Ç.svg" alt="shield" style="width: 10px; height: 10px; vertical-align: middle; margin-right: 2px;"> ${cell.neutral_defenders}`;
                        };
                        
                        shieldImg.onerror = function() {
                            // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–º–æ–¥–∑–∏
                            defendersElement.innerHTML = `üõ°Ô∏è ${cell.neutral_defenders}`;
                        };
                        
                        defendersElement.style.display = 'block';
                    } else {
                        defendersElement.style.display = 'none';
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ–Ω—É—Å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–∫–∞—Ö
                    let resourceBonusElement = cellElement.querySelector('.resource-bonus');
                    if (!resourceBonusElement) {
                        resourceBonusElement = document.createElement('div');
                        resourceBonusElement.className = 'resource-bonus';
                        resourceBonusElement.style.position = 'absolute';
                        resourceBonusElement.style.top = '2px';
                        resourceBonusElement.style.right = '2px';
                        resourceBonusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                        resourceBonusElement.style.color = 'white';
                        resourceBonusElement.style.padding = '1px 2px';
                        resourceBonusElement.style.borderRadius = '3px';
                        resourceBonusElement.style.fontSize = '8px';
                        cellElement.appendChild(resourceBonusElement);
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–∫–∞—Ö
                    const x = parseInt(cell.x);
                    const y = parseInt(cell.y);
                    
                    if ((x === 1 && y === 3) || (x === 3 && y === 1) || (x === 3 && y === 5) || (x === 5 && y === 3)) {
                        let resourceType = '';
                        let resourceColor = '';
                        
                        if (x === 1 && y === 3) {
                            resourceType = 'gold'; // –ó–æ–ª–æ—Ç–æ
                            resourceColor = '#FFD700';
                        } else if (x === 3 && y === 1) {
                            resourceType = 'wood'; // –î–µ—Ä–µ–≤–æ
                            resourceColor = '#228B22';
                        } else if (x === 3 && y === 5) {
                            resourceType = 'ore'; // –†—É–¥–∞
                            resourceColor = '#A9A9A9';
                        } else if (x === 5 && y === 3) {
                            resourceType = 'stone'; // –ö–∞–º–µ–Ω—å
                            resourceColor = '#708090';
                        }
                        
                        resourceBonusElement.innerHTML = `${getResourceIcon(resourceType)} +20%`;
                        resourceBonusElement.style.display = 'block';
                        resourceBonusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                        resourceBonusElement.style.borderColor = resourceColor;
                    } else if (x === 3 && y === 3) {
                        // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–ª–µ—Ç–∫–∞ —Å –±–æ–Ω—É—Å–æ–º –∫ –≤–æ–∏–Ω–∞–º
                        resourceBonusElement.innerHTML = `${getResourceIcon('warriors')} +20%`;
                        resourceBonusElement.style.display = 'block';
                        resourceBonusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
                        resourceBonusElement.style.borderColor = '#FF4500'; // OrangeRed
                    } else {
                        resourceBonusElement.style.display = 'none';
                    }
                });
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã:', error));
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
    function updateResources() {
        if (!userFactionId) return;
        
        fetch('/api/resources')
            .then(response => response.json())
            .then(data => {
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ –∏–∫–æ–Ω–∫–∞–º–∏
                document.getElementById('gold-amount').innerHTML = `<img src="/static/assets/resources/–ó–æ–ª–æ—Ç–æ.svg" alt="gold" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;"> –ó–æ–ª–æ—Ç–æ: ${data.gold}`;
                document.getElementById('wood-amount').innerHTML = `<img src="/static/assets/resources/–î–µ—Ä–µ–≤–æ.svg" alt="wood" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;"> –î–µ—Ä–µ–≤–æ: ${data.wood}`;
                document.getElementById('stone-amount').innerHTML = `<img src="/static/assets/resources/–ö–∞–º–µ–Ω—å.svg" alt="stone" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;"> –ö–∞–º–µ–Ω—å: ${data.stone}`;
                document.getElementById('ore-amount').innerHTML = `<img src="/static/assets/resources/–†—É–¥–∞.svg" alt="ore" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;"> –†—É–¥–∞: ${data.ore}`;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–∏–Ω–æ–≤, –≤–∫–ª—é—á–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–æ–∏–Ω–∞—Ö
                const warriorsElement = document.getElementById('warriors-amount');
                warriorsElement.innerHTML = `<img src="/static/assets/resources/–í–æ–∏–Ω—ã.svg" alt="warriors" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;"> –í–æ–∏–Ω—ã: ${data.warriors}`;
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–æ–∏–Ω–∞—Ö, –¥–æ–±–∞–≤–ª—è–µ–º –µ—ë –≤ —Å–∫–æ–±–∫–∞—Ö
                if (data.total_warriors_sent && data.total_warriors_sent > 0) {
                    let detailText = '';
                    
                    if (data.warriors_sent > 0 && data.warriors_defending > 0) {
                        detailText = `${data.total_warriors_sent} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ (${data.warriors_sent} –Ω–∞ –∑–∞—Ö–≤–∞—Ç, ${data.warriors_defending} –Ω–∞ –∑–∞—â–∏—Ç—É)`;
                    } else if (data.warriors_sent > 0) {
                        detailText = `${data.warriors_sent} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –∑–∞—Ö–≤–∞—Ç`;
                    } else if (data.warriors_defending > 0) {
                        detailText = `${data.warriors_defending} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –∑–∞—â–∏—Ç—É`;
                    }
                    
                    warriorsElement.innerHTML += ` (${detailText})`;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∏–Ω–æ–≤ –≤ —Ñ–æ—Ä–º–µ –∑–∞—Ö–≤–∞—Ç–∞
                document.getElementById('available-warriors').textContent = data.warriors;
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤:', error));
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ —Ñ—Ä–∞–∫—Ü–∏–∏
    function getFactionColor(factionId) {
        const colors = {
            1: '#ff6b6b', // –ö—Ä–∞—Å–Ω—ã–π
            2: '#4ecdc4', // –ë–∏—Ä—é–∑–æ–≤—ã–π
            3: '#ffe66d', // –ñ–µ–ª—Ç—ã–π
            4: '#6b5b95'  // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        };
        return colors[factionId] || '#cccccc';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –∑–¥–∞–Ω–∏—è
    function getBuildingIcon(buildingType) {
        if (!buildingType) return '';
        
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∏–ø –∑–¥–∞–Ω–∏—è –≤ –Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
        const type = buildingType.toLowerCase();
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∑–¥–∞–Ω–∏—è
        let imagePath = '';
        switch (type) {
            case 'castle':
                imagePath = '/static/assets/buildings/–ó–∞–º–æ–∫.svg';
                break;
            case 'sawmill':
                imagePath = '/static/assets/buildings/–õ–µ—Å–æ–ø–∏–ª–∫–∞.svg';
                break;
            case 'mine':
                imagePath = '/static/assets/buildings/–®–∞—Ö—Ç–∞.svg';
                break;
            case 'quarry':
                imagePath = '/static/assets/buildings/–ö–∞—Ä—å–µ—Ä.svg';
                break;
            case 'warehouse':
                imagePath = '/static/assets/buildings/–°–∫–ª–∞–¥.svg';
                break;
            case 'barracks':
                imagePath = '/static/assets/buildings/–ö–∞–∑–∞—Ä–º–∞.svg';
                break;
            default:
                imagePath = '/static/assets/buildings/–ö–∞–∑–∞—Ä–º—ã.svg';
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTML —Å —Ç–µ–≥–æ–º img
        return `<img src="${imagePath}" alt="${type}" style="width: 32px; height: 32px;">`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Ä–µ—Å—É—Ä—Å–∞
    function getResourceIcon(resourceType) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É—Ç—å –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ä–µ—Å—É—Ä—Å–∞
        let imagePath = '';
        switch (resourceType) {
            case 'gold':
                imagePath = '/static/assets/resources/–ó–æ–ª–æ—Ç–æ.svg';
                break;
            case 'wood':
                imagePath = '/static/assets/resources/–î–µ—Ä–µ–≤–æ.svg';
                break;
            case 'stone':
                imagePath = '/static/assets/resources/–ö–∞–º–µ–Ω—å.svg';
                break;
            case 'ore':
                imagePath = '/static/assets/resources/–†—É–¥–∞.svg';
                break;
            case 'warriors':
                imagePath = '/static/assets/resources/–í–æ–∏–Ω—ã.svg';
                break;
            default:
                return '';
        }
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º HTML —Å —Ç–µ–≥–æ–º img
        return `<img src="${imagePath}" alt="${resourceType}" style="width: 12px; height: 12px; vertical-align: middle;">`;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è
    function executeAction(actionType, x, y, buildingType = null, additionalData = null) {
        console.log(`–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è: ${actionType} –Ω–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö (${x}, ${y})`);
        
        const data = {
            action_type: actionType,
            target_x: x,
            target_y: y
        };
        
        if (buildingType) {
            data.building_type = buildingType;
        }
        
        if (additionalData) {
            if (actionType === 'CAPTURE_CELL' && typeof additionalData === 'number') {
                data.warriors = additionalData;
            } else if (actionType === 'TRANSFER_RESOURCES' && typeof additionalData === 'object') {
                data.resources = additionalData;
            }
        }
        
        fetch('/api/execute_direct_action', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (actionType === 'CAPTURE_CELL') {
                    // –î–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–ª–µ—Ç–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    showNotification(result.message, 'info');
                } else if (actionType === 'BUILD') {
                    // –î–ª—è —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    showNotification(result.message, 'info');
                } else {
                    // –î–ª—è –¥—Ä—É–≥–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    showNotification('–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!', 'success');
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã (—Ä–µ—Å—É—Ä—Å—ã –∏ —Ç.–¥.)
                updateResources();
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏ —Ñ—Ä–∞–∫—Ü–∏–∏
                updateFactionLogs();
            } else {
                showNotification(`–û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è:', error);
            showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –¥–µ–π—Å—Ç–≤–∏—è', 'error');
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} notification`;
        notification.textContent = message;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        notification.style.padding = '15px';
        notification.style.borderRadius = '5px';
        notification.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s ease-in-out';
        
        // –î–æ–±–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ DOM
        document.body.appendChild(notification);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        setTimeout(() => {
            notification.style.opacity = '1';
        }, 10);
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            notification.style.opacity = '0';
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
    function initMap() {
        const mapContainer = document.querySelector('.map-container');
        if (!mapContainer) return;
        
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        mapContainer.innerHTML = '';
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
        fetch('/api/map')
            .then(response => response.json())
            .then(mapData => {
                console.log('Initial map data:', mapData);
                
                // –°–æ–∑–¥–∞–µ–º –∫–ª–µ—Ç–∫–∏
                mapData.forEach(cell => {
                    const cellElement = createCellElement(cell);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–ª–µ—Ç–∫–∏
                    cellElement.addEventListener('click', function() {
                        // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö
                        document.querySelectorAll('#capture-x, #build-x, #defend-x').forEach(el => el.value = cell.x);
                        document.querySelectorAll('#capture-y, #build-y, #defend-y').forEach(el => el.value = cell.y);
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–µ—Ç–∫—É –Ω–∞ –∫–∞—Ä—Ç—É
                    mapContainer.appendChild(cellElement);
                });
            })
            .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞—Ä—Ç—ã:', error));
    }
    
    function createCellElement(cell) {
        const cellElement = document.createElement('div');
        cellElement.className = 'map-cell';
        cellElement.dataset.x = cell.x;
        cellElement.dataset.y = cell.y;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç —Ñ–æ–Ω–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ—Ä–∞–∫—Ü–∏–∏
        if (cell.faction_id) {
            cellElement.style.backgroundColor = getFactionColor(cell.faction_id);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∫–ª–µ—Ç–∫–∏ –≤ —É–≥–ª—É
        const coords = document.createElement('div');
        coords.className = 'coords';
        coords.textContent = `${cell.x},${cell.y}`;
        cellElement.appendChild(coords);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª–µ—Ç–∫–∞ –∑–∞–º–∫–æ–º
        let isCastle = false;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ—Ä–∞–∫—Ü–∏–∏ –Ω–∞–¥ –∑–∞–º–∫–æ–º, –µ—Å–ª–∏ —ç—Ç–æ –∑–∞–º–æ–∫
        if ((cell.building_type && cell.building_type.toLowerCase() === 'castle') || 
            (cell.faction_id && isCornerCell(parseInt(cell.x), parseInt(cell.y)))) {
            isCastle = true;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ—Ä–∞–∫—Ü–∏–∏ –Ω–∞–¥ –∑–∞–º–∫–æ–º
            if (cell.faction_id && cell.faction_name) {
                const factionLabel = document.createElement('div');
                factionLabel.className = 'faction-label';
                factionLabel.textContent = cell.faction_name;
                factionLabel.style.position = 'absolute';
                factionLabel.style.top = '2px';
                factionLabel.style.left = '50%';
                factionLabel.style.transform = 'translateX(-50%)';
                factionLabel.style.fontSize = '7px';
                factionLabel.style.fontWeight = 'bold';
                factionLabel.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                factionLabel.style.color = 'white';
                factionLabel.style.padding = '1px 2px';
                factionLabel.style.borderRadius = '2px';
                factionLabel.style.zIndex = '10';
                cellElement.appendChild(factionLabel);
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–¥–∞–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        const buildingIcon = document.createElement('div');
        buildingIcon.className = 'building-icon';
        
        if (cell.building_type) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é getBuildingIcon –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è HTML —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            buildingIcon.innerHTML = getBuildingIcon(cell.building_type);
            buildingIcon.style.display = 'flex';
        } else if (cell.faction_id && isCornerCell(parseInt(cell.x), parseInt(cell.y))) {
            // –ï—Å–ª–∏ —ç—Ç–æ —É–≥–ª–æ–≤–∞—è –∫–ª–µ—Ç–∫–∞ —Å —Ñ—Ä–∞–∫—Ü–∏–µ–π, –Ω–æ –±–µ–∑ –∑–¥–∞–Ω–∏—è, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞–º–æ–∫
            buildingIcon.innerHTML = getBuildingIcon('castle');
            buildingIcon.style.display = 'flex';
        } else {
            buildingIcon.style.display = 'none';
        }
        
        cellElement.appendChild(buildingIcon);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞—Ö –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–æ–∫ —Å –ø–æ—Å—Ç—Ä–æ–π–∫–∞–º–∏
        let defendersElement = document.createElement('div');
        defendersElement.className = 'neutral-defenders';
        defendersElement.style.position = 'absolute';
        defendersElement.style.bottom = '2px';
        defendersElement.style.right = '2px';
        defendersElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)'; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω–∞
        defendersElement.style.color = 'white';
        defendersElement.style.padding = '0px 2px 1px 2px'; // –ê—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã: –≤–µ—Ä—Ö 0px, –ø—Ä–∞–≤–æ 2px, –Ω–∏–∑ 1px, –ª–µ–≤–æ 2px
        defendersElement.style.borderRadius = '3px';
        defendersElement.style.fontSize = '10px'; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
        defendersElement.style.zIndex = '5'; // –î–æ–±–∞–≤–ª—è–µ–º z-index
        cellElement.appendChild(defendersElement);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—â–∏—Ç–Ω–∏–∫–∞—Ö
        if (cell.faction_id === null && cell.building_type && cell.neutral_defenders) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ SVG, –µ—Å–ª–∏ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –∏–∫–æ–Ω–∫—É
            const shieldImg = new Image();
            shieldImg.src = '/static/assets/resources/–©–∏—Ç.svg';
            
            shieldImg.onload = function() {
                defendersElement.innerHTML = `<img src="/static/assets/resources/–©–∏—Ç.svg" alt="shield" style="width: 10px; height: 10px; vertical-align: middle; margin-right: 2px;"> ${cell.neutral_defenders}`;
            };
            
            shieldImg.onerror = function() {
                // –ï—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º —ç–º–æ–¥–∑–∏
                defendersElement.innerHTML = `üõ°Ô∏è ${cell.neutral_defenders}`;
            };
            
            defendersElement.style.display = 'block';
        } else {
            defendersElement.style.display = 'none';
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ–Ω—É—Å–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–∫–∞—Ö
        let resourceBonusElement = document.createElement('div');
        resourceBonusElement.className = 'resource-bonus';
        resourceBonusElement.style.position = 'absolute';
        resourceBonusElement.style.top = '2px';
        resourceBonusElement.style.right = '2px';
        resourceBonusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        resourceBonusElement.style.color = 'white';
        resourceBonusElement.style.padding = '1px 2px';
        resourceBonusElement.style.borderRadius = '3px';
        resourceBonusElement.style.fontSize = '8px';
        cellElement.appendChild(resourceBonusElement);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–Ω–∞—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–ª–µ—Ç–∫–∞—Ö
        const x = parseInt(cell.x);
        const y = parseInt(cell.y);
        
        if ((x === 1 && y === 3) || (x === 3 && y === 1) || (x === 3 && y === 5) || (x === 5 && y === 3)) {
            let resourceType = '';
            let resourceColor = '';
            
            if (x === 1 && y === 3) {
                resourceType = 'gold'; // –ó–æ–ª–æ—Ç–æ
                resourceColor = '#FFD700';
            } else if (x === 3 && y === 1) {
                resourceType = 'wood'; // –î–µ—Ä–µ–≤–æ
                resourceColor = '#228B22';
            } else if (x === 3 && y === 5) {
                resourceType = 'ore'; // –†—É–¥–∞
                resourceColor = '#A9A9A9';
            } else if (x === 5 && y === 3) {
                resourceType = 'stone'; // –ö–∞–º–µ–Ω—å
                resourceColor = '#708090';
            }
            
            resourceBonusElement.innerHTML = `${getResourceIcon(resourceType)} +20%`;
            resourceBonusElement.style.display = 'block';
            resourceBonusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            resourceBonusElement.style.borderColor = resourceColor;
        } else if (x === 3 && y === 3) {
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–ª–µ—Ç–∫–∞ —Å –±–æ–Ω—É—Å–æ–º –∫ –≤–æ–∏–Ω–∞–º
            resourceBonusElement.innerHTML = `${getResourceIcon('warriors')} +20%`;
            resourceBonusElement.style.display = 'block';
            resourceBonusElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            resourceBonusElement.style.borderColor = '#FF4500'; // OrangeRed
        } else {
            resourceBonusElement.style.display = 'none';
        }
        
        return cellElement;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–ª–µ—Ç–∫–∞ —É–≥–ª–æ–≤–æ–π (–Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏–µ–π)
    function isCornerCell(x, y) {
        const corners = [[0, 0], [0, 6], [6, 0], [6, 6]];
        for (let i = 0; i < corners.length; i++) {
            if (corners[i][0] === x && corners[i][1] === y) {
                return true;
            }
        }
        return false;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    function initEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –ø—Ä–∞–≤–æ–π –∫–æ–ª–æ–Ω–∫–µ
        const captureCellBtn = document.getElementById('capture-cell-btn');
        if (captureCellBtn) {
            captureCellBtn.addEventListener('click', function() {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞—Ö–≤–∞—Ç–∞ –∫–ª–µ—Ç–∫–∏
                const modal = new bootstrap.Modal(document.getElementById('captureCellModal'));
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤–æ–∏–Ω–æ–≤ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                document.getElementById('capture-warriors').value = 1;
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∏–Ω–æ–≤
                updateResources();
                modal.show();
            });
        }
        
        const buildBtn = document.getElementById('build-btn');
        if (buildBtn) {
            buildBtn.addEventListener('click', function() {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞
                const modal = new bootstrap.Modal(document.getElementById('buildModal'));
                modal.show();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –Ω–∞–π–º–∞ –≤–æ–∏–Ω–æ–≤
        const recruitWarriorsBtn = document.getElementById('recruit-warriors-btn');
        if (recruitWarriorsBtn) {
            recruitWarriorsBtn.addEventListener('click', function() {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–π–º–∞ –≤–æ–∏–Ω–æ–≤
                const modal = new bootstrap.Modal(document.getElementById('recruitWarriorsModal'));
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–ª–æ—Ç–∞
                updateRecruitModalGold();
                modal.show();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–æ–∏–Ω–æ–≤ –≤ —Ñ–æ—Ä–º–µ –Ω–∞–π–º–∞
        const recruitWarriorsInput = document.getElementById('recruit-warriors');
        if (recruitWarriorsInput) {
            recruitWarriorsInput.addEventListener('input', function() {
                updateRecruitCost();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞–π–º–∞ –≤–æ–∏–Ω–æ–≤
        const confirmRecruitBtn = document.getElementById('confirm-recruit');
        if (confirmRecruitBtn) {
            confirmRecruitBtn.addEventListener('click', function() {
                const warriors = parseInt(document.getElementById('recruit-warriors').value);
                
                // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤–æ–∏–Ω–æ–≤
                const data = {
                    action_type: 'RECRUIT_WARRIORS',
                    target_x: 0,
                    target_y: 0,
                    warriors: warriors
                };
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è executeAction
                fetch('/api/execute_direct_action', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification(result.message, 'success');
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
                        updateResources();
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏ —Ñ—Ä–∞–∫—Ü–∏–∏
                        updateFactionLogs();
                    } else {
                        showNotification(`–û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–π–º–µ –≤–æ–∏–Ω–æ–≤:', error);
                    showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–π–º–µ –≤–æ–∏–Ω–æ–≤', 'error');
                });
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('recruitWarriorsModal'));
                modal.hide();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∑–¥–∞–Ω–∏—è
        const buildingTypeSelect = document.getElementById('building-type');
        if (buildingTypeSelect) {
            buildingTypeSelect.addEventListener('change', function() {
                updateBuildingCost(this.value);
            });
        }
        
        const transferResourcesBtn = document.getElementById('transfer-resources-btn');
        if (transferResourcesBtn) {
            transferResourcesBtn.addEventListener('click', function() {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
                const modal = new bootstrap.Modal(document.getElementById('transferModal'));
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã
                updateResources();
                modal.show();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞ –∫–ª–µ—Ç–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const confirmCaptureBtn = document.getElementById('confirm-capture');
        if (confirmCaptureBtn) {
            confirmCaptureBtn.addEventListener('click', function() {
                const x = parseInt(document.getElementById('capture-x').value);
                const y = parseInt(document.getElementById('capture-y').value);
                const warriors = parseInt(document.getElementById('capture-warriors').value);
                
                executeAction('CAPTURE_CELL', x, y, null, warriors);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('captureCellModal'));
                modal.hide();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const confirmBuildBtn = document.getElementById('confirm-build');
        if (confirmBuildBtn) {
            confirmBuildBtn.addEventListener('click', function() {
                const x = parseInt(document.getElementById('build-x').value);
                const y = parseInt(document.getElementById('build-y').value);
                const buildingType = document.getElementById('building-type').value;
                
                executeAction('BUILD', x, y, buildingType);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('buildModal'));
                modal.hide();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–¥–∞—á–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
        const confirmTransferBtn = document.getElementById('confirm-transfer');
        if (confirmTransferBtn) {
            confirmTransferBtn.addEventListener('click', function() {
                const factionId = document.getElementById('transfer-faction').value;
                const wood = parseInt(document.getElementById('transfer-wood').value) || 0;
                const stone = parseInt(document.getElementById('transfer-stone').value) || 0;
                const gold = parseInt(document.getElementById('transfer-gold').value) || 0;
                const ore = parseInt(document.getElementById('transfer-ore').value) || 0;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è
                if (wood + stone + gold + ore === 0) {
                    showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ä–µ—Å—É—Ä—Å –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏', 'error');
                    return;
                }
                
                const resources = { wood, stone, gold, ore, faction_id: factionId };
                executeAction('TRANSFER_RESOURCES', 0, 0, null, resources);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                const modal = bootstrap.Modal.getInstance(document.getElementById('transferModal'));
                modal.hide();
            });
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∫–ª–µ—Ç–∫–∏ –∫–∞—Ä—Ç—ã
        const mapCells = document.querySelectorAll('.map-cell');
        mapCells.forEach(cell => {
            cell.addEventListener('click', function() {
                const x = parseInt(this.dataset.x);
                const y = parseInt(this.dataset.y);
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–ª—è –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö
                document.querySelectorAll('#capture-x, #build-x, #defend-x').forEach(el => el.value = x);
                document.querySelectorAll('#capture-y, #build-y, #defend-y').forEach(el => el.value = y);
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞—â–∏—Ç—ã –∫–ª–µ—Ç–∫–∏
        const defendCellBtn = document.getElementById('defend-cell-btn');
        if (defendCellBtn) {
            defendCellBtn.addEventListener('click', function() {
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∑–∞—â–∏—Ç—ã –∫–ª–µ—Ç–∫–∏
                const modal = new bootstrap.Modal(document.getElementById('defendCellModal'));
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∏–Ω–æ–≤
                updateDefendModalWarriors();
                modal.show();
            });
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–¥–∞–Ω–∏—è
    function updateBuildingCost(buildingType) {
        const buildingCostDiv = document.getElementById('building-cost');
        if (!buildingCostDiv) return;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–¥–∞–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
        const buildingCosts = {
            'SAWMILL': {gold: 30, wood: 10, stone: 15, ore: 5},
            'MINE': {gold: 30, wood: 15, stone: 10, ore: 5},
            'QUARRY': {gold: 30, wood: 15, stone: 5, ore: 10},
            'WAREHOUSE': {gold: 20, wood: 20, stone: 20, ore: 0},
            'BARRACKS': {gold: 40, wood: 15, stone: 15, ore: 10}
        };
        
        // –ï—Å–ª–∏ —Ç–∏–ø –∑–¥–∞–Ω–∏—è –Ω–µ –≤—ã–±—Ä–∞–Ω –∏–ª–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω
        if (!buildingType || !buildingCosts[buildingType]) {
            buildingCostDiv.innerHTML = '<p class="mb-1">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∑–¥–∞–Ω–∏—è, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å</p>';
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∑–¥–∞–Ω–∏—è
        const cost = buildingCosts[buildingType];
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        let costHTML = `
            <ul class="list-unstyled">
                <li>${getResourceIcon('gold')} –ó–æ–ª–æ—Ç–æ: ${cost.gold}</li>
                <li>${getResourceIcon('wood')} –î–µ—Ä–µ–≤–æ: ${cost.wood}</li>
                <li>${getResourceIcon('stone')} –ö–∞–º–µ–Ω—å: ${cost.stone}</li>
                <li>${getResourceIcon('ore')} –†—É–¥–∞: ${cost.ore}</li>
            </ul>
        `;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–ª–æ–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        buildingCostDiv.innerHTML = costHTML;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–∞–π–º–∞ –≤–æ–∏–Ω–æ–≤
    function updateRecruitCost() {
        const warriorsCount = parseInt(document.getElementById('recruit-warriors').value) || 0;
        const costPerWarrior = 5;
        const totalCost = warriorsCount * costPerWarrior;
        
        document.getElementById('total-recruit-cost').textContent = totalCost;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ –∑–æ–ª–æ—Ç–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –Ω–∞–π–º–∞
    function updateRecruitModalGold() {
        const goldAmount = document.getElementById('gold-amount').textContent;
        document.getElementById('available-gold-recruit').textContent = goldAmount;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    function initModalEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–π–º–∞ –≤–æ–∏–Ω–æ–≤
        const recruitModal = document.getElementById('recruitWarriorsModal');
        if (recruitModal) {
            recruitModal.addEventListener('shown.bs.modal', function() {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∑–æ–ª–æ—Ç–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                updateRecruitModalGold();
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç—å –Ω–∞–π–º–∞
                updateRecruitCost();
            });
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–æ–∏–Ω–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –∑–∞—â–∏—Ç—ã
    function updateDefendModalWarriors() {
        const warriorsAmount = document.getElementById('warriors-amount');
        const availableWarriors = document.getElementById('available-warriors-defend');
        
        if (warriorsAmount && availableWarriors) {
            availableWarriors.textContent = warriorsAmount.textContent;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—è –≤–≤–æ–¥–∞
            const defendWarriorsInput = document.getElementById('defend-warriors');
            if (defendWarriorsInput) {
                defendWarriorsInput.max = warriorsAmount.textContent;
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞—â–∏—Ç—ã –∫–ª–µ—Ç–∫–∏
    const confirmDefendBtn = document.getElementById('confirm-defend');
    if (confirmDefendBtn) {
        confirmDefendBtn.addEventListener('click', function() {
            const warriors = parseInt(document.getElementById('defend-warriors').value);
            const x = parseInt(document.getElementById('defend-x').value);
            const y = parseInt(document.getElementById('defend-y').value);
            
            // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –∑–∞—â–∏—Ç–µ
            const data = {
                action_type: 'DEFEND_CELL',
                target_x: x,
                target_y: y,
                warriors: warriors
            };
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
            fetch('/api/execute_direct_action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showNotification(result.message, 'success');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã
                    updateResources();
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–≥–∏ —Ñ—Ä–∞–∫—Ü–∏–∏
                    updateFactionLogs();
                } else {
                    showNotification(`–û—à–∏–±–∫–∞: ${result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞—â–∏—Ç–µ –∫–ª–µ—Ç–∫–∏:', error);
                showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞—â–∏—Ç–µ –∫–ª–µ—Ç–∫–∏', 'error');
            });
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = bootstrap.Modal.getInstance(document.getElementById('defendCellModal'));
            modal.hide();
        });
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –°–Ω–∞—á–∞–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
        initMap();
        
        // –ó–∞—Ç–µ–º –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        initEventListeners();
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        initModalEventListeners();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –∫–ª–µ—Ç–∫–∏ —É—Å–ø–µ–ª–∏ —Å–æ–∑–¥–∞—Ç—å—Å—è
        setTimeout(function() {
            // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
            updateGameState();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞ —Ö–æ–¥–∞ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            setInterval(updateTurnTimer, 1000);
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã –∏ —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            setInterval(function() {
                updateMap();
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ä–µ—Å—É—Ä—Å–æ–≤ –∏ –ª–æ–≥–æ–≤
                if (userFactionId) {
                    updateResources();
                    updateFactionLogs();
                }
            }, 5000);
        }, 1000);
    });
</script>
{% endblock %} 